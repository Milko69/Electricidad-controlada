<!DOCTYPE html>
<html lang="es">
<head>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // ESTA ES LA CONEXIÓN CORREGIDA SEGÚN TUS FOTOS
  const SB_URL = "https://powkyikeyoghogpzfrpk.supabase.co"; 
  const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1tdm9rc3lsa2Jpbmh4a2RvbWJ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkyNjYxMDgsImV4cCI6MjA4NDg0MjEwOH0.t61ChuadD-BeYd95l69G7wMtj5Asn9CJT9IJqMXwTxQ"; 
  
  const _supabase = window.supabase.createClient(SB_URL, SB_KEY);

  async function validarAcceso() {
      const input = document.getElementById('accessCode').value.trim();
      const feedback = document.getElementById('loginFeedback');
      feedback.textContent = "Verificando...";

      try {
          // Buscamos en tu tabla 'clientes'
          const { data, error } = await _supabase
              .from('clientes')
              .select('*')
              .eq('clave_cliente', input);

          if (error) throw error;

          if (data && data.length > 0) {
              const cliente = data[0];
              if (cliente.suscripcion_activa) {
                  document.getElementById('loginOverlay').style.display = 'none';
              } else {
                  // Tu requisito: Si no paga, solo ve la lista básica
                  document.getElementById('loginOverlay').style.display = 'none';
                  document.querySelectorAll('.tab-btn').forEach(btn => {
                      if (btn.innerText !== 'Clientes') btn.style.display = 'none';
                  });
                  alert("Suscripción pendiente de pago.");
              }
          } else {
              feedback.textContent = "Código no válido.";
          }
      } catch (err) {
          console.error(err);
          feedback.textContent = "Error de comunicación con el servidor.";
      }
  }
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ElectroGestión Pro - Full Finance + IVA</title>
    <!-- Iconos -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #007bff;
            --primary-dark: #0056b3;
            --secondary: #ffc107;
            --secondary-dark: #d39e00;
            --dark: #343a40;
            --light: #f8f9fa;
            --danger: #dc3545;
            --success: #28a745;
            --gray: #6c757d;
            --border-radius: 8px;
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f0f2f5;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- Sidebar --- */
        aside {
            width: 260px;
            background-color: var(--dark);
            color: white;
            display: flex;
            flex-direction: column;
            transition: 0.3s;
            flex-shrink: 0;
            overflow-y: auto;
        }

        .brand {
            padding: 20px;
            font-size: 1.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid #4b545c;
        }

        .brand i { color: var(--secondary); }

        nav ul { list-style: none; padding-top: 20px; }

        nav li {
            padding: 12px 20px;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
            border-left: 4px solid transparent;
            font-size: 0.95rem;
        }

        nav li:hover, nav li.active {
            background-color: #495057;
            border-left-color: var(--secondary);
        }

        /* --- Main Content --- */
        main {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            position: relative;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        h2 { color: var(--dark); font-size: 1.5rem; }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: var(--primary-dark); }
        .btn-secondary { background-color: var(--secondary); color: var(--dark); }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-success { background-color: var(--success); color: white; }
        .btn-sm { padding: 5px 10px; font-size: 0.8rem; }

        /* --- Sections --- */
        section { display: none; animation: fadeIn 0.3s ease; }
        section.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Cards --- */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            text-align: left;
            position: relative;
            overflow: hidden;
        }
        
        .card.positive { border-left: 5px solid var(--success); }
        .card.negative { border-left: 5px solid var(--danger); }
        .card.neutral { border-left: 5px solid var(--primary); }

        .card h3 { color: var(--gray); font-size: 0.9rem; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px; }
        .card .number { font-size: 2rem; font-weight: bold; color: var(--dark); }
        .card i.pos-icon { position: absolute; right: 20px; top: 20px; font-size: 2rem; color: #e9ecef; }

        /* --- Tables --- */
        .table-container {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow-x: auto;
        }

        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background-color: #f8f9fa; color: var(--dark); font-weight: 600; font-size: 0.9rem; }
        tr:hover { background-color: #f1f1f1; }
        
        .money { font-family: 'Courier New', Courier, monospace; font-weight: bold; }

        /* --- Forms & Inputs --- */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: var(--dark); font-weight: 500; font-size: 0.9rem; }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: var(--border-radius);
            font-size: 0.95rem;
        }
        input:focus { outline: 2px solid var(--primary); border-color: transparent; }

        /* --- Charts --- */
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            height: 300px;
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            padding-bottom: 40px;
            position: relative;
        }
        
        .bar-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 40px;
            position: relative;
        }

        .bar {
            width: 100%;
            background: var(--primary);
            border-radius: 4px 4px 0 0;
            transition: height 0.5s;
            min-height: 2px;
        }
        .bar.expense { background: var(--danger); }
        .bar.profit { background: var(--success); }

        .bar-label {
            margin-top: 10px;
            font-size: 0.75rem;
            color: var(--gray);
            text-align: center;
            transform: rotate(-45deg);
            white-space: nowrap;
            position: absolute;
            bottom: -35px;
        }

        .chart-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }
        .legend-item { display: flex; align-items: center; gap: 5px; }
        .dot { width: 12px; height: 12px; border-radius: 50%; }

        /* --- Modals --- */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: none; justify-content: center; align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: white; padding: 30px; border-radius: var(--border-radius);
            width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto;
        }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .close-modal { cursor: pointer; font-size: 1.5rem; }

        /* --- Toast --- */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 2000; }
        .toast {
            background: var(--dark); color: white; padding: 12px 24px;
            border-radius: var(--border-radius); margin-top: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex; align-items: center; gap: 10px;
            animation: slideIn 0.3s;
        }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        /* --- Tools --- */
        .tools-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .tool-card { background: white; padding: 25px; border-radius: var(--border-radius); box-shadow: var(--shadow); border-top: 5px solid var(--secondary); }
        .tool-card h3 { margin-bottom: 20px; color: var(--dark); border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .calc-result { margin-top: 15px; padding: 10px; background: #e9ecef; border-radius: var(--border-radius); text-align: center; font-weight: bold; color: var(--primary-dark); }

        /* --- Print Layout --- */
        #print-layout { display: none; background: white; color: black; padding: 40px; }
        @media print {
            aside, header, .no-print, .btn, #toast-container, .modal { display: none !important; }
            body, main { background: white; margin: 0; padding: 0; display: block; overflow: visible; }
            #print-layout { display: block !important; position: absolute; top: 0; left: 0; width: 100%; }
            * { -webkit-print-color-adjust: exact; }
        }

        /* Estilos específicos para los totales en modal */
        .presupuesto-totales {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .total-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .total-row.grand-total { 
            border-top: 1px solid #ddd; 
            padding-top: 10px; 
            margin-top: 10px; 
            font-size: 1.2rem; 
            font-weight: bold; 
            color: var(--primary-dark); 
        }

        /* Responsive */
        @media (max-width: 768px) {
            aside { position: absolute; left: -260px; height: 100%; z-index: 100; }
            aside.open { left: 0; }
            .mobile-toggle { display: block !important; }
            .chart-container { overflow-x: scroll; justify-content: flex-start; padding-left: 10px; }
            .bar-group { margin-right: 15px; flex-shrink: 0; }
        }
        .mobile-toggle { display: none; font-size: 1.5rem; cursor: pointer; margin-right: 15px; }
    </style>
</head>
<body>
    <div id="login-overlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#1a202c; z-index:9999; display:flex; align-items:center; justify-content:center; color:white; font-family:sans-serif;"> <div style="background:#2d3748; padding:30px; border-radius:12px; box-shadow:0 10px 25px rgba(0,0,0,0.5); width:90%; max-width:400px; text-align:center;"> <h2 style="margin-bottom:20px; color:#4fd1c5;">ElectroGestión Pro ⚡</h2> <p style="margin-bottom:20px; font-size:14px; color:#a0aec0;">Ingresa tu código de acceso para continuar</p> <input type="text" id="access-code" placeholder="Código de Acceso" style="width:100%; padding:12px; margin-bottom:15px; border-radius:6px; border:none; outline:none; color:#1a202c; font-weight:bold; text-align:center;"> <button onclick="validarIngreso()" style="width:100%; padding:12px; background:#4fd1c5; color:#1a202c; border:none; border-radius:6px; font-weight:bold; cursor:pointer; transition:0.3s;"> INGRESAR AL SISTEMA </button> <p id="login-error" style="color:#f56565; margin-top:15px; font-size:13px; display:none;">Código incorrecto o suscripción vencida.</p> <div style="margin-top:25px; border-top:1px solid #4a5568; padding-top:15px;"> <p style="font-size:12px; color:#a0aec0;">¿No tienes acceso? <a href="#" style="color:#4fd1c5;">Contactar Soporte</a></p> </div> </div> </div>


    <aside id="sidebar">
        <div class="brand">
            <i class="fas fa-bolt"></i> ElectroGestión
        </div>
        <nav>
            <ul>
                <li class="active" onclick="showSection('dashboard', this)"><i class="fas fa-home"></i> Inicio</li>
                <li onclick="showSection('clientes', this)"><i class="fas fa-users"></i> Clientes</li>
                <li onclick="showSection('proveedores', this)"><i class="fas fa-truck"></i> Proveedores</li>
                <li onclick="showSection('presupuestos', this)"><i class="fas fa-file-invoice-dollar"></i> Presupuestos</li>
                <!-- FINANZAS -->
                <li onclick="showSection('compras', this)"><i class="fas fa-shopping-cart"></i> Compras (Gastos)</li>
                <li onclick="showSection('ventas', this)"><i class="fas fa-money-bill-wave"></i> Ventas (Ingresos)</li>
                <li onclick="showSection('reportes', this)"><i class="fas fa-chart-pie"></i> Reportes y Resultado</li>
                <!-- HERRAMIENTAS -->
                <li onclick="showSection('herramientas', this)"><i class="fas fa-calculator"></i> Fórmulas y Tools</li>
            </ul>
        </nav>
    </aside>

    <main>
        <header class="no-print">
            <div style="display: flex; align-items: center;">
                <i class="fas fa-bars mobile-toggle" onclick="toggleSidebar()"></i>
                <h2 id="page-title">Resumen General</h2>
            </div>
            <div id="header-actions"></div>
        </header>

        <!-- LAYOUT IMPRESIÓN -->
        <div id="print-layout">
            <div class="print-header" style="display:flex; justify-content:space-between; border-bottom:2px solid #000; padding-bottom:20px; margin-bottom:20px;">
                <div>
                    <h1>PRESUPUESTO</h1>
                    <p>ElectroGestión Pro</p>
                    <p>Tel: <span id="print-telefono"></span></p>
                </div>
                <div style="text-align:right;">
                    <h3>Nº: <span id="print-id"></span></h3>
                    <p>Fecha: <span id="print-fecha"></span></p>
                </div>
            </div>
            <div style="background:#f9f9f9; padding:15px; margin-bottom:20px; display:flex; justify-content:space-between;">
                <div>
                    <strong>CLIENTE:</strong><br>
                    <span id="print-cliente-nombre"></span><br>
                    <span id="print-cliente-dir"></span>
                </div>
                <div style="text-align:right;">
                    <strong>CONTACTO:</strong><br>
                    <span id="print-cliente-tel"></span>
                </div>
            </div>
            <table style="width:100%; border-collapse:collapse; margin-bottom:30px;">
                <thead>
                    <tr style="background:#000; color:#fff;">
                        <th style="padding:10px; text-align:left;">Descripción</th>
                        <th style="padding:10px; text-align:left;">Cant.</th>
                        <th style="padding:10px; text-align:left;">Precio Unit.</th>
                        <th style="padding:10px; text-align:right;">Subtotal</th>
                    </tr>
                </thead>
                <tbody id="print-items-body"></tbody>
            </table>
            
            <!-- ÁREA DE TOTALES EN IMPRESIÓN -->
            <div style="width: 50%; margin-left: auto; text-align: right;">
                <div style="margin-bottom: 5px;">Subtotal: <span id="print-subtotal" style="font-weight:bold;">$0.00</span></div>
                <div style="margin-bottom: 5px;">IVA (<span id="print-iva-pct">0</span>%): <span id="print-iva-val">$0.00</span></div>
                <div style="font-size: 1.8rem; font-weight: bold; border-top: 1px solid black; padding-top: 5px; margin-top: 5px;">
                    Total: <span id="print-total">$0.00</span>
                </div>
            </div>

            <div style="margin-top:60px; display:flex; justify-content:space-between;">
                <div style="border-top:1px solid #000; width:40%; text-align:center; padding-top:5px;">Firma Electricista</div>
                <div style="border-top:1px solid #000; width:40%; text-align:center; padding-top:5px;">Aceptación Cliente</div>
            </div>
        </div>

        <div id="toast-container"></div>

        <!-- DASHBOARD -->
        <section id="dashboard" class="active no-print">
            <div class="stats-grid">
                <div class="card">
                    <h3><i class="fas fa-users"></i> Clientes</h3>
                    <div class="number" id="dash-clientes">0</div>
                </div>
                <div class="card neutral">
                    <h3><i class="fas fa-file-invoice"></i> Presupuestos Activos</h3>
                    <div class="number" id="dash-presupuestos">0</div>
                </div>
                <div class="card positive">
                    <h3><i class="fas fa-arrow-up"></i> Ingresos (Mes)</h3>
                    <div class="number" id="dash-ingresos-mes">$0</div>
                </div>
                <div class="card negative">
                    <h3><i class="fas fa-arrow-down"></i> Gastos (Mes)</h3>
                    <div class="number" id="dash-gastos-mes">$0</div>
                </div>
            </div>
        </section>

        <!-- CLIENTES -->
        <section id="clientes" class="no-print">
            <div class="table-container">
                <table>
                    <thead><tr><th>Nombre</th><th>Teléfono</th><th>Email</th><th>Dirección</th><th>Acciones</th></tr></thead>
                    <tbody id="clientes-body"></tbody>
                </table>
            </div>
        </section>

        <!-- PROVEEDORES -->
        <section id="proveedores" class="no-print">
            <div class="table-container">
                <table>
                    <thead><tr><th>Empresa</th><th>Contacto</th><th>Teléfono</th><th>Material</th><th>Acciones</th></tr></thead>
                    <tbody id="proveedores-body"></tbody>
                </table>
            </div>
        </section>

        <!-- PRESUPUESTOS -->
        <section id="presupuestos" class="no-print">
            <div class="table-container">
                <table>
                    <thead><tr><th>Nº</th><th>Cliente</th><th>Fecha</th><th>Total</th><th>Estado</th><th>Acciones</th></tr></thead>
                    <tbody id="presupuestos-body"></tbody>
                </table>
            </div>
        </section>

        <!-- COMPRAS (GASTOS) -->
        <section id="compras" class="no-print">
            <div class="table-container">
                <table>
                    <thead><tr><th>Fecha</th><th>Descripción</th><th>Proveedor</th><th>Monto</th><th>Acciones</th></tr></thead>
                    <tbody id="compras-body"></tbody>
                </table>
            </div>
        </section>

        <!-- VENTAS (INGRESOS) -->
        <section id="ventas" class="no-print">
            <div class="table-container">
                <table>
                    <thead><tr><th>Fecha</th><th>Descripción</th><th>Cliente</th><th>Monto</th><th>Acciones</th></tr></thead>
                    <tbody id="ventas-body"></tbody>
                </table>
            </div>
        </section>

        <!-- REPORTES Y RESULTADO -->
        <section id="reportes" class="no-print">
            <!-- Configuración de Impuestos -->
            <div style="background:white; padding:20px; border-radius:8px; margin-bottom:20px; box-shadow:var(--shadow); display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:15px;">
                <div>
                    <h3 style="color:var(--dark); margin-bottom:5px;">Cálculo de Ganancia Neta</h3>
                    <p style="color:var(--gray); font-size:0.9rem;">Configura el porcentaje de impuestos/retenciones a descontar de la ganancia bruta.</p>
                </div>
                <div style="display:flex; align-items:center; gap:10px;">
                    <label>Impuestos/Retención (%):</label>
                    <input type="number" id="tax-percent" value="0" min="0" max="100" style="width:80px;" onchange="renderReportes()">
                    <span>%</span>
                </div>
            </div>

            <!-- Tarjetas Resumen Global -->
            <div class="stats-grid">
                <div class="card positive">
                    <i class="fas fa-coins pos-icon"></i>
                    <h3>Ventas Totales</h3>
                    <div class="number" id="rep-ventas-total">$0</div>
                </div>
                <div class="card negative">
                    <i class="fas fa-receipt pos-icon"></i>
                    <h3>Gastos Totales</h3>
                    <div class="number" id="rep-gastos-total">$0</div>
                </div>
                <div class="card neutral">
                    <i class="fas fa-balance-scale pos-icon"></i>
                    <h3>Ganancia Bruta</h3>
                    <div class="number" id="rep-bruta">$0</div>
                </div>
                <div class="card positive">
                    <i class="fas fa-wallet pos-icon"></i>
                    <h3>Ganancia Neta</h3>
                    <div class="number" id="rep-neta">$0</div>
                </div>
            </div>

            <!-- Gráfico Mensual -->
            <h3 style="margin-bottom:20px;">Histórico de Ganancias (Últimos 6 meses)</h3>
            <div class="chart-container" id="chart-container">
                <!-- Barras generadas por JS -->
            </div>
            <div class="chart-legend">
                <div class="legend-item"><div class="dot" style="background:var(--success)"></div>Ganancia</div>
                <div class="legend-item"><div class="dot" style="background:var(--primary)"></div>Ventas</div>
                <div class="legend-item"><div class="dot" style="background:var(--danger)"></div>Gastos</div>
            </div>

            <!-- Detalle Mensual Tabla -->
            <h3 style="margin-top:40px; margin-bottom:20px;">Detalle Mes a Mes</h3>
            <div class="table-container">
                <table>
                    <thead><tr><th>Mes</th><th>Ventas</th><th>Gastos</th><th>Ganancia Bruta</th><th>Impuestos</th><th>Ganancia Neta</th></tr></thead>
                    <tbody id="reportes-table-body"></tbody>
                </table>
            </div>
        </section>

        <!-- HERRAMIENTAS -->
        <section id="herramientas" class="no-print">
            <div class="tools-grid">
                <div class="tool-card">
                    <h3>Ley de Ohm</h3>
                    <input type="number" id="ohm-v" placeholder="Voltaje (V)" oninput="calcOhm()" class="form-group"><br>
                    <input type="number" id="ohm-i" placeholder="Intensidad (I)" oninput="calcOhm()" class="form-group"><br>
                    <input type="number" id="ohm-r" placeholder="Resistencia (R)" oninput="calcOhm()" class="form-group"><br>
                    <div id="ohm-res" class="calc-result">Completa 2 campos</div>
                </div>
                <div class="tool-card">
                    <h3>Caída de Tensión</h3>
                    <select id="volt-mat" class="form-group"><option value="0.0175">Cobre</option><option value="0.028">Aluminio</option></select>
                    <input type="number" id="volt-amps" placeholder="Intensidad (A)" class="form-group" oninput="calcVolt()">
                    <input type="number" id="volt-len" placeholder="Longitud (m)" class="form-group" oninput="calcVolt()">
                    <input type="number" id="volt-sec" placeholder="Sección (mm²)" class="form-group" oninput="calcVolt()">
                    <div id="volt-res" class="calc-result">0 V</div>
                </div>
            </div>
        </section>

    </main>

    <!-- MODALES -->
    <div id="modal-cliente" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>Nuevo Cliente</h3><span class="close-modal" onclick="closeM('modal-cliente')">&times;</span></div>
            <form onsubmit="saveCliente(event)">
                <input type="text" id="c-nom" placeholder="Nombre" required class="form-group">
                <input type="text" id="c-tel" placeholder="Teléfono" class="form-group">
                <input type="text" id="c-mail" placeholder="Email" class="form-group">
                <input type="text" id="c-dir" placeholder="Dirección" class="form-group">
                <button class="btn btn-primary" style="width:100%">Guardar</button>
            </form>
        </div>
    </div>

    <div id="modal-proveedor" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>Nuevo Proveedor</h3><span class="close-modal" onclick="closeM('modal-proveedor')">&times;</span></div>
            <form onsubmit="saveProv(event)">
                <input type="text" id="p-nom" placeholder="Nombre Empresa" required class="form-group">
                <input type="text" id="p-cont" placeholder="Contacto" class="form-group">
                <input type="text" id="p-tel" placeholder="Teléfono" class="form-group">
                <input type="text" id="p-mat" placeholder="Material Principal" class="form-group">
                <button class="btn btn-primary" style="width:100%">Guardar</button>
            </form>
        </div>
    </div>

    <div id="modal-presupuesto" class="modal">
        <div class="modal-content" style="max-width:700px">
            <div class="modal-header"><h3>Nuevo Presupuesto</h3><span class="close-modal" onclick="closeM('modal-presupuesto')">&times;</span></div>
            <form onsubmit="savePres(event)">
                <select id="pres-cli" required class="form-group"></select>
                <table style="width:100%; margin-bottom:10px;">
                    <thead><tr><th>Desc</th><th>Cant</th><th>$</th><th></th></tr></thead>
                    <tbody id="pres-items"></tbody>
                </table>
                <button type="button" class="btn btn-secondary btn-sm" onclick="addPresItem()">+ Item</button>
                
                <!-- Área de Cálculos de Presupuesto (Subtotal, IVA, Total) -->
                <div class="presupuesto-totales">
                    <div class="total-row">
                        <span>Subtotal:</span>
                        <span>$<span id="pres-subtotal">0.00</span></span>
                    </div>
                    <div class="total-row" style="align-items: center;">
                        <span>IVA (%):</span>
                        <div style="display:flex; gap:5px; align-items:center;">
                            <input type="number" id="pres-iva-pct" value="21" min="0" style="width:60px; padding:5px;" oninput="calcPresTot()">
                            <span>=</span>
                            <span>$<span id="pres-iva-val">0.00</span></span>
                        </div>
                    </div>
                    <div class="total-row grand-total">
                        <span>Total:</span>
                        <span>$<span id="pres-total">0.00</span></span>
                    </div>
                </div>

                <button class="btn btn-primary" style="width:100%; margin-top:15px;">Guardar Presupuesto</button>
            </form>
        </div>
    </div>

    <div id="modal-gasto" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>Registrar Compra/Gasto</h3><span class="close-modal" onclick="closeM('modal-gasto')">&times;</span></div>
            <form onsubmit="saveGasto(event)">
                <label>Fecha</label>
                <input type="date" id="g-fecha" required class="form-group">
                <label>Descripción</label>
                <input type="text" id="g-desc" placeholder="Ej: Cables 2.5mm" required class="form-group">
                <label>Proveedor (Opcional)</label>
                <select id="g-prov" class="form-group"><option value="">Ninguno</option></select>
                <label>Monto</label>
                <input type="number" id="g-monto" required class="form-group">
                <button class="btn btn-danger" style="width:100%">Registrar Gasto</button>
            </form>
        </div>
    </div>

    <div id="modal-venta" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>Registrar Venta Manual</h3><span class="close-modal" onclick="closeM('modal-venta')">&times;</span></div>
            <form onsubmit="saveVentaManual(event)">
                <label>Fecha</label>
                <input type="date" id="v-fecha" required class="form-group">
                <label>Descripción</label>
                <input type="text" id="v-desc" placeholder="Ej: Reparación tomacorriente" required class="form-group">
                <label>Cliente (Opcional)</label>
                <select id="v-cli" class="form-group"><option value="">Consumidor Final</option></select>
                <label>Monto Cobrado</label>
                <input type="number" id="v-monto" required class="form-group">
                <button class="btn btn-success" style="width:100%">Registrar Venta</button>
            </form>
        </div>
    </div>

    <script>
        // --- ESTADO & DB ---
        const DB_KEY = 'electroData_v4';
        let db = {
            clientes: [], proveedores: [], presupuestos: [], gastos: [], ventas: []
        };

        function loadData() {
            const s = localStorage.getItem(DB_KEY);
            if(s) db = JSON.parse(s);
            else {
                // Datos Demo
                db.clientes = [{id:1, nombre:"Juan Perez", tel:"123", email:"a@b.com", dir:"Calle 1"}];
                db.proveedores = [{id:1, nombre:"SICA", contacto:"Pedro", tel:"555", material:"Cables"}];
                saveData();
            }
            renderAll();
        }

        function saveData() { localStorage.setItem(DB_KEY, JSON.stringify(db)); renderDashboard(); }

        function id() { return Date.now().toString(36); }

        // --- UI GENERAL ---
        function showSection(id, nav) {
            document.querySelectorAll('section').forEach(e => e.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('nav li').forEach(e => e.classList.remove('active'));
            if(nav) nav.classList.add('active');
            
            const actions = document.getElementById('header-actions');
            actions.innerHTML = '';
            
            if(id==='clientes') { actions.innerHTML=`<button class="btn btn-primary" onclick="openM('modal-cliente')">+ Cliente</button>`; renderClientes(); }
            else if(id==='proveedores') { actions.innerHTML=`<button class="btn btn-primary" onclick="openM('modal-proveedor')">+ Proveedor</button>`; renderProv(); }
            else if(id==='presupuestos') { actions.innerHTML=`<button class="btn btn-primary" onclick="prepPres()">+ Presupuesto</button>`; renderPres(); }
            else if(id==='compras') { actions.innerHTML=`<button class="btn btn-danger" onclick="prepGasto()">+ Gasto</button>`; renderGastos(); }
            else if(id==='ventas') { actions.innerHTML=`<button class="btn btn-success" onclick="prepVenta()">+ Venta Manual</button>`; renderVentas(); }
            else if(id==='reportes') renderReportes();
            else if(id==='dashboard') renderDashboard();

            if(window.innerWidth<=768) document.getElementById('sidebar').classList.remove('open');
        }

        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }

        function openM(id) { document.getElementById(id).style.display='flex'; }
        function closeM(id) { document.getElementById(id).style.display='none'; }
        function toast(msg) {
            const d = document.createElement('div');
            d.className='toast'; d.innerHTML=`<i class="fas fa-check"></i> ${msg}`;
            document.getElementById('toast-container').appendChild(d);
            setTimeout(()=>d.remove(), 3000);
        }

        // --- LOGICA NEGOCIO ---
        function saveCliente(e) {
            e.preventDefault();
            db.clientes.push({id:id(), nombre:document.getElementById('c-nom').value, tel:document.getElementById('c-tel').value, email:document.getElementById('c-mail').value, dir:document.getElementById('c-dir').value});
            saveData(); closeM('modal-cliente'); e.target.reset(); toast("Cliente Guardado");
        }
        function renderClientes() {
            const t = document.getElementById('clientes-body'); t.innerHTML='';
            db.clientes.forEach(c => t.innerHTML+=`<tr><td>${c.nombre}</td><td>${c.tel}</td><td>${c.email}</td><td>${c.dir}</td><td><button class="btn btn-danger btn-sm" onclick="del('clientes','${c.id}')"><i class="fas fa-trash"></i></button></td></tr>`);
        }

        function saveProv(e) {
            e.preventDefault();
            db.proveedores.push({id:id(), nombre:document.getElementById('p-nom').value, contacto:document.getElementById('p-cont').value, tel:document.getElementById('p-tel').value, material:document.getElementById('p-mat').value});
            saveData(); closeM('modal-proveedor'); e.target.reset(); toast("Proveedor Guardado");
        }
        function renderProv() {
            const t = document.getElementById('proveedores-body'); t.innerHTML='';
            db.proveedores.forEach(p => t.innerHTML+=`<tr><td>${p.nombre}</td><td>${p.contacto}</td><td>${p.tel}</td><td>${p.material}</td><td><button class="btn btn-danger btn-sm" onclick="del('proveedores','${p.id}')"><i class="fas fa-trash"></i></button></td></tr>`);
        }

        // --- PRESUPUESTOS (ACTUALIZADO CON IVA) ---
        function prepPres() {
            const s = document.getElementById('pres-cli'); s.innerHTML='<option value="">Cliente...</option>';
            db.clientes.forEach(c => s.innerHTML+=`<option value="${c.id}">${c.nombre}</option>`);
            document.getElementById('pres-items').innerHTML=''; addPresItem();
            document.getElementById('pres-iva-pct').value = 21; // Default IVA
            calcPresTot();
            openM('modal-presupuesto');
        }
        function addPresItem() {
            const tr = document.createElement('tr');
            tr.innerHTML=`<td><input type="text" class="p-desc" placeholder="Item" style="width:100%"></td><td><input type="number" class="p-cant" value="1" style="width:50px" oninput="calcPresTot()"></td><td><input type="number" class="p-price" value="0" style="width:80px" oninput="calcPresTot()"></td><td><i class="fas fa-times" style="color:red; cursor:pointer" onclick="this.closest('tr').remove(); calcPresTot()"></i></td>`;
            document.getElementById('pres-items').appendChild(tr);
        }
        function calcPresTot() {
            let sub = 0;
            document.querySelectorAll('#pres-items tr').forEach(r=>{
                sub += (parseFloat(r.querySelector('.p-cant').value)||0) * (parseFloat(r.querySelector('.p-price').value)||0);
            });
            
            const ivaPct = parseFloat(document.getElementById('pres-iva-pct').value) || 0;
            const ivaVal = sub * (ivaPct / 100);
            const tot = sub + ivaVal;

            document.getElementById('pres-subtotal').innerText = sub.toFixed(2);
            document.getElementById('pres-iva-val').innerText = ivaVal.toFixed(2);
            document.getElementById('pres-total').innerText = tot.toFixed(2);

            return { sub, ivaPct, ivaVal, tot };
        }
        function savePres(e) {
            e.preventDefault();
            const cli = document.getElementById('pres-cli').value;
            if(!cli) return alert("Elija cliente");
            const its = [];
            document.querySelectorAll('#pres-items tr').forEach(r => its.push({
                desc: r.querySelector('.p-desc').value, cant: r.querySelector('.p-cant').value, price: r.querySelector('.p-price').value
            }));
            
            const calc = calcPresTot();

            db.presupuestos.push({
                id:id(), 
                clienteId:cli, 
                fecha:new Date().toLocaleDateString(), 
                items:its, 
                subtotal: calc.sub, 
                ivaPercent: calc.ivaPct, 
                ivaValue: calc.ivaVal,
                total:calc.tot, 
                estado:'pendiente', 
                pagado:false
            });
            saveData(); closeM('modal-presupuesto'); toast("Presupuesto Creado");
        }
        function renderPres() {
            const t = document.getElementById('presupuestos-body'); t.innerHTML='';
            [...db.presupuestos].reverse().forEach(p => {
                const c = db.clientes.find(x=>x.id==p.clienteId)?.nombre || '???';
                let badge = p.estado==='pagado'?'status-paid':'status-pending';
                t.innerHTML+=`<tr><td>#${p.id.substr(0,5)}</td><td>${c}</td><td>${p.fecha}</td><td><b>$${p.total}</b></td><td><span class="${badge}" style="background:${p.estado==='pagado'?'#d4edda':'#ffeeba'}; padding:2px 6px; border-radius:4px; font-size:0.8rem">${p.estado.toUpperCase()}</span></td>
                <td>
                    <button class="btn btn-secondary btn-sm" onclick="printPres('${p.id}')"><i class="fas fa-print"></i></button>
                    <button class="btn btn-secondary btn-sm" onclick="togEstado('${p.id}')"><i class="fas fa-sync"></i></button>
                </td></tr>`;
            });
        }
        function togEstado(pid) {
            const p = db.presupuestos.find(x=>x.id===pid);
            if(!p) return;
            if(p.estado==='pendiente') p.estado='aprobado';
            else if(p.estado==='aprobado') {
                p.estado='pagado';
                // GENERAR VENTA AUTOMÁTICA
                if(!p.pagado) {
                    db.ventas.push({
                        id:id(),
                        fecha:new Date().toLocaleDateString(),
                        descripcion:`Cobro Presupuesto #${p.id.substr(0,5)}`,
                        clienteId:p.clienteId,
                        origen:'presupuesto',
                        monto:p.total // Registrar el TOTAL con IVA como venta
                    });
                    p.pagado = true;
                    toast("Venta registrada automáticamente");
                }
            }
            else p.estado='pendiente';
            saveData(); renderPres();
        }

        // --- COMPRAS (GASTOS) ---
        function prepGasto() {
            const s = document.getElementById('g-prov'); s.innerHTML='<option value="">Ninguno</option>';
            db.proveedores.forEach(p => s.innerHTML+=`<option value="${p.id}">${p.nombre}</option>`);
            document.getElementById('g-fecha').valueAsDate = new Date();
            openM('modal-gasto');
        }
        function saveGasto(e) {
            e.preventDefault();
            db.gastos.push({
                id:id(),
                fecha:document.getElementById('g-fecha').value,
                descripcion:document.getElementById('g-desc').value,
                proveedorId:document.getElementById('g-prov').value,
                monto:parseFloat(document.getElementById('g-monto').value)
            });
            saveData(); closeM('modal-gasto'); toast("Gasto Registrado");
        }
        function renderGastos() {
            const t = document.getElementById('compras-body'); t.innerHTML='';
            [...db.gastos].reverse().forEach(g => {
                const p = db.proveedores.find(x=>x.id==g.proveedorId)?.nombre || '-';
                t.innerHTML+=`<tr><td>${g.fecha}</td><td>${g.descripcion}</td><td>${p}</td><td class="money" style="color:var(--danger)">-$${g.monto}</td><td><button class="btn btn-danger btn-sm" onclick="del('gastos','${g.id}')"><i class="fas fa-trash"></i></button></td></tr>`;
            });
        }

        // --- VENTAS ---
        function prepVenta() {
            const s = document.getElementById('v-cli'); s.innerHTML='<option value="">Consumidor Final</option>';
            db.clientes.forEach(c => s.innerHTML+=`<option value="${c.id}">${c.nombre}</option>`);
            document.getElementById('v-fecha').valueAsDate = new Date();
            openM('modal-venta');
        }
        function saveVentaManual(e) {
            e.preventDefault();
            db.ventas.push({
                id:id(),
                fecha:document.getElementById('v-fecha').value,
                descripcion:document.getElementById('v-desc').value,
                clienteId:document.getElementById('v-cli').value,
                origen:'manual',
                monto:parseFloat(document.getElementById('v-monto').value)
            });
            saveData(); closeM('modal-venta'); toast("Venta Registrada");
        }
        function renderVentas() {
            const t = document.getElementById('ventas-body'); t.innerHTML='';
            [...db.ventas].reverse().forEach(v => {
                const c = db.clientes.find(x=>x.id==v.clienteId)?.nombre || '-';
                t.innerHTML+=`<tr><td>${v.fecha}</td><td>${v.descripcion} <small>(${v.origen})</small></td><td>${c}</td><td class="money" style="color:var(--success)">+$${v.monto}</td><td><button class="btn btn-danger btn-sm" onclick="del('ventas','${v.id}')"><i class="fas fa-trash"></i></button></td></tr>`;
            });
        }

        // --- REPORTES ---
        function renderReportes() {
            const totalVentas = db.ventas.reduce((a,b)=>a+parseFloat(b.monto),0);
            const totalGastos = db.gastos.reduce((a,b)=>a+parseFloat(b.monto),0);
            const bruta = totalVentas - totalGastos;
            const taxP = parseFloat(document.getElementById('tax-percent').value) || 0;
            const impuesto = bruta * (taxP/100);
            const neta = bruta - impuesto;

            document.getElementById('rep-ventas-total').innerText = `$${totalVentas}`;
            document.getElementById('rep-gastos-total').innerText = `$${totalGastos}`;
            document.getElementById('rep-bruta').innerText = `$${bruta}`;
            document.getElementById('rep-neta').innerText = `$${neta}`;

            // Meses
            const meses = {};
            for(let i=5; i>=0; i--) {
                const d = new Date();
                d.setMonth(d.getMonth() - i);
                const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
                meses[key] = { v:0, g:0, label: d.toLocaleDateString('es-ES', {month:'short'}) };
            }

            db.ventas.forEach(v => {
                let key = v.fecha; 
                if(v.fecha.includes('/')) { const parts = v.fecha.split('/'); if(parts.length===3) key = `${parts[2]}-${parts[1].padStart(2,'0')}`; }
                if(meses[key]) meses[key].v += parseFloat(v.monto);
            });

            db.gastos.forEach(g => {
                let key = g.fecha;
                if(g.fecha.includes('/')) { const parts = g.fecha.split('/'); if(parts.length===3) key = `${parts[2]}-${parts[1].padStart(2,'0')}`; }
                if(meses[key]) meses[key].g += parseFloat(g.monto);
            });

            const chart = document.getElementById('chart-container');
            chart.innerHTML = '';
            const maxVal = Math.max(...Object.values(meses).map(m => Math.max(m.v, m.g, 1)));

            Object.values(meses).forEach(m => {
                const hV = (m.v / maxVal) * 100;
                const hG = (m.g / maxVal) * 100;
                const hP = ((m.v - m.g) / maxVal) * 100;

                const group = document.createElement('div');
                group.className = 'bar-group';
                group.innerHTML = `
                    <div style="display:flex; align-items:flex-end; height:100%; gap:4px; width:60px;">
                        <div class="bar profit" title="Ganancia: $${m.v-m.g}" style="height:${Math.max(0,hP)}%"></div>
                        <div class="bar expense" title="Gastos: $${m.g}" style="height:${hG}%"></div>
                        <div class="bar" title="Ventas: $${m.v}" style="height:${hV}%"></div>
                    </div>
                    <div class="bar-label">${m.label}</div>
                `;
                chart.appendChild(group);
            });

            const tbody = document.getElementById('reportes-table-body');
            tbody.innerHTML = '';
            Object.entries(meses).reverse().forEach(([k,m]) => {
                const b = m.v - m.g;
                const imp = b * (taxP/100);
                const n = b - imp;
                tbody.innerHTML += `<tr>
                    <td>${m.label}</td>
                    <td style="color:var(--success)">$${m.v}</td>
                    <td style="color:var(--danger)">$${m.g}</td>
                    <td><b>$${b}</b></td>
                    <td style="color:var(--gray)">-$${imp.toFixed(2)}</td>
                    <td style="font-weight:bold">$${n.toFixed(2)}</td>
                </tr>`;
            });
        }

        // --- DASHBOARD ---
        function renderDashboard() {
            document.getElementById('dash-clientes').innerText = db.clientes.length;
            document.getElementById('dash-presupuestos').innerText = db.presupuestos.filter(p=>p.estado!=='pagado').length;
            
            const cm = new Date().getMonth();
            const cy = new Date().getFullYear();
            const k = `${cy}-${String(cm+1).padStart(2,'0')}`;

            let vMes = 0, gMes = 0;
            db.ventas.forEach(v => {
                if(v.fecha.includes('-')) {
                    const parts = v.fecha.split('-');
                    if(parts[0]==cy && parts[1]==String(cm+1).padStart(2,'0')) vMes+=v.monto;
                }
            });
            db.gastos.forEach(g => {
                 if(g.fecha.includes('-')) {
                    const parts = g.fecha.split('-');
                    if(parts[0]==cy && parts[1]==String(cm+1).padStart(2,'0')) gMes+=g.monto;
                }
            });

            document.getElementById('dash-ingresos-mes').innerText = `$${vMes}`;
            document.getElementById('dash-gastos-mes').innerText = `$${gMes}`;
        }

        // --- UTILIDADES ---
        function del(col, id) {
            if(!confirm("¿Borrar?")) return;
            db[col] = db[col].filter(x => x.id !== id);
            saveData();
            if(col=='clientes') renderClientes();
            if(col=='proveedores') renderProv();
            if(col=='gastos') renderGastos();
            if(col=='ventas') renderVentas();
        }
        function renderAll() { renderDashboard(); }

        // --- IMPRESIÓN (ACTUALIZADO CON IVA) ---
        function printPres(id) {
            const p = db.presupuestos.find(x=>x.id===id);
            const c = db.clientes.find(x=>x.id===p.clienteId);
            if(!p) return;

            document.getElementById('print-id').innerText = p.id.substr(0,6);
            document.getElementById('print-fecha').innerText = p.fecha;
            document.getElementById('print-telefono').innerText = "Tu Teléfono";
            if(c) {
                document.getElementById('print-cliente-nombre').innerText = c.nombre;
                document.getElementById('print-cliente-dir').innerText = c.dir;
                document.getElementById('print-cliente-tel').innerText = c.tel;
            }
            const tb = document.getElementById('print-items-body'); tb.innerHTML='';
            p.items.forEach(i => {
                tb.innerHTML+=`<tr><td>${i.desc}</td><td>${i.cant}</td><td>$${i.price}</td><td style="text-align:right">$${i.cant*i.price}</td></tr>`;
            });

            // Llenar datos de IVA y Totales (Fallback para presupuestos viejos sin IVA)
            document.getElementById('print-subtotal').innerText = (p.subtotal || p.total).toFixed(2);
            document.getElementById('print-iva-pct').innerText = (p.ivaPercent || 0);
            document.getElementById('print-iva-val').innerText = (p.ivaValue || 0).toFixed(2);
            document.getElementById('print-total').innerText = p.total.toFixed(2);

            window.print();
        }

        // --- HERRAMIENTAS ---
        function calcOhm() {
            const v=parseFloat(document.getElementById('ohm-v').value);
            const i=parseFloat(document.getElementById('ohm-i').value);
            const r=parseFloat(document.getElementById('ohm-r').value);
            const res=document.getElementById('ohm-res');
            if(v&&i) res.innerText=`R: ${(v/i).toFixed(2)} Ω - P: ${(v*i).toFixed(2)} W`;
            else if(v&&r) res.innerText=`I: ${(v/r).toFixed(2)} A - P: ${(v*v/r).toFixed(2)} W`;
            else if(i&&r) res.innerText=`V: ${(i*r).toFixed(2)} V - P: ${(i*i*r).toFixed(2)} W`;
            else res.innerText="Ingresa 2 datos";
        }
        function calcVolt() {
            const rho=parseFloat(document.getElementById('volt-mat').value);
            const i=parseFloat(document.getElementById('volt-amps').value);
            const l=parseFloat(document.getElementById('volt-len').value);
            const s=parseFloat(document.getElementById('volt-sec').value);
            if(i&&l&&s) document.getElementById('volt-res').innerText = `Caída: ${((2*rho*l*i)/s).toFixed(2)} V`;
        }

        window.onload = loadData;
        async function validarIngreso() {
            const cuadro = document.getElementById('access-code');
            const codigo = cuadro.value;
            const errorMsg = document.getElementById('login-error');
            const pantallaCierre = document.getElementById('login-overlay');

            try {
                // Consultamos a Supabase usando el nombre exacto de tu nueva columna
                const { data, error } = await supabase
                    .from('clientes')
                    .select('*')
                    .eq('clave_cliente', codigo) 
                    .single();

                if (data) {
                    if (data.suscripcion_activa === true) {
                        // SI PAGÓ: Entra normal
                        pantallaCierre.style.display = 'none';
                        console.log("Acceso concedido");
                    } else {
                        // NO PAGÓ: Solo funcionalidad básica (instrucción del 23-01-2026)
                        alert("Suscripción vencida. Solo disponible lista de clientes básica.");
                        pantallaCierre.style.display = 'none';
                        // Aquí puedes agregar lógica para ocultar botones de edición
                    }
                } else {
                    // El código no existe en la base de datos
                    errorMsg.style.display = 'block';
                    errorMsg.innerText = "Código incorrecto o no registrado.";
                }
            } catch (err) {
                console.log("Error de conexión:", err);
                errorMsg.innerText = "Error de comunicación con el servidor.";
                errorMsg.style.display = 'block';
            }
        }
        window.onload = loadData;
    </script>
</body>
</html>
